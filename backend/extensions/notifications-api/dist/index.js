var t={id:"notifications-api",handler:(t,{services:e,database:r,getSchema:a,logger:i})=>{const{ItemsService:s}=e;t.get("/",async(t,e)=>{try{const r=t.accountability?.user;if(!r)return e.status(401).json({error:"Authentification requise"});const i=await a(),n=new s("notifications",{schema:i,accountability:t.accountability}),o=await n.readByQuery({filter:{user_id:{_eq:r}},fields:["id","user_id","message","project_id","event_type","status","triggered_by","date_created"],sort:["-date_created"],limit:50}),u=o.filter(t=>"non_lu"===t.status).length;e.json({success:!0,data:o,unread_count:u,total:o.length})}catch(t){i.error("Erreur récupération notifications:",t),e.status(500).json({error:"Erreur interne du serveur",details:t.message})}}),t.patch("/:id/read",async(t,e)=>{try{const{id:r}=t.params,n=t.accountability?.user;if(!n)return e.status(401).json({error:"Authentification requise"});const o=await a(),u=new s("notifications",{schema:o,accountability:t.accountability}),c=await u.readOne(r);if(!c)return e.status(404).json({error:"Notification non trouvée"});if(c.user_id!==n)return e.status(403).json({error:"Accès non autorisé à cette notification"});await u.updateOne(r,{status:"lu"}),i.info(`Notification ${r} marquée comme lue par user ${n}`),e.json({success:!0,message:"Notification marquée comme lue",data:{id:r,status:"lu"}})}catch(t){i.error("Erreur marquage notification:",t),e.status(500).json({error:"Erreur interne du serveur",details:t.message})}}),t.patch("/read-all",async(t,e)=>{try{const r=t.accountability?.user;if(!r)return e.status(401).json({error:"Authentification requise"});const n=await a(),o=new s("notifications",{schema:n,accountability:t.accountability}),u=(await o.readByQuery({filter:{user_id:{_eq:r},status:{_eq:"non_lu"}},fields:["id"]})).map(t=>t.id);u.length>0&&await o.updateMany(u,{status:"lu"}),i.info(`${u.length} notifications marquées comme lues pour user ${r}`),e.json({success:!0,message:`${u.length} notification(s) marquée(s) comme lue(s)`,data:{updated_count:u.length}})}catch(t){i.error("Erreur marquage toutes notifications:",t),e.status(500).json({error:"Erreur interne du serveur",details:t.message})}}),t.delete("/:id",async(t,e)=>{try{const{id:r}=t.params,n=t.accountability?.user;if(!n)return e.status(401).json({error:"Authentification requise"});const o=await a(),u=new s("notifications",{schema:o,accountability:t.accountability}),c=await u.readOne(r);if(!c)return e.status(404).json({error:"Notification non trouvée"});if(c.user_id!==n)return e.status(403).json({error:"Accès non autorisé à cette notification"});await u.deleteOne(r),i.info(`Notification ${r} supprimée par user ${n}`),e.json({success:!0,message:"Notification supprimée"})}catch(t){i.error("Erreur suppression notification:",t),e.status(500).json({error:"Erreur interne du serveur",details:t.message})}})}};export{t as default};
